import fs from "node:fs";
import path from "node:path";

const ROOT = path.join(process.cwd(), "public", "projects");
const OUT  = path.join(process.cwd(), "data", "category-images.ts");

const CAT_KEYS = new Set(["extensions", "renovations", "new-builds"]);

function walk(dir) {
  let out = [];
  for (const ent of fs.readdirSync(dir, { withFileTypes: true })) {
    const p = path.join(dir, ent.name);
    if (ent.isDirectory()) out = out.concat(walk(p));
    else out.push(p);
  }
  return out;
}

function isImage(p) {
  return /\.(jpg|jpeg|png|webp)$/i.test(p);
}

function toPublicUrl(absPath) {
  const rel = path.relative(path.join(process.cwd(), "public"), absPath);
  return "/" + rel.split(path.sep).join("/");
}

const categoryImages = {
  extensions: [],
  renovations: [],
  "new-builds": [],
};

for (const cat of fs.readdirSync(ROOT, { withFileTypes: true }).filter(d => d.isDirectory()).map(d => d.name)) {
  if (!CAT_KEYS.has(cat)) continue;

  const absCatDir = path.join(ROOT, cat);
  const files = walk(absCatDir).filter(isImage);

  // stable-ish ordering
  files.sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" }));

  categoryImages[cat] = files.map(toPublicUrl);
}

const file = `// AUTO-GENERATED. Do not edit by hand.
// Generated by scripts/generate-category-images.mjs

export type CategoryKey = "extensions" | "renovations" | "new-builds";

export const categoryImages: Record<CategoryKey, string[]> = ${JSON.stringify(categoryImages, null, 2)} as const;

export function getCategoryImages(category: CategoryKey) {
  return categoryImages[category] ?? [];
}
`;

fs.mkdirSync(path.dirname(OUT), { recursive: true });
fs.writeFileSync(OUT, file, "utf8");
console.log("OK: wrote data/category-images.ts");
