import fs from "node:fs";
import path from "node:path";

const ROOT = path.join(process.cwd(), "public", "projects");
const OUT = path.join(process.cwd(), "data", "projects.ts");

const CAT_LABEL = {
  "extensions": "Extensions",
  "renovations": "Renovations",
  "new-builds": "New Builds",
};

function exists(p) {
  try { fs.accessSync(p); return true; } catch { return false; }
}

function listDirs(p) {
  return fs.readdirSync(p, { withFileTypes: true })
    .filter(d => d.isDirectory())
    .map(d => d.name);
}

function listFiles(p) {
  return fs.readdirSync(p, { withFileTypes: true })
    .filter(d => d.isFile())
    .map(d => d.name);
}

function isImage(name) {
  return /\.(jpg|jpeg|png|webp)$/i.test(name);
}

function sortProjectDirs(a, b) {
  // project-02, project-10 numeric sort
  const na = Number((a.match(/(\d+)/)?.[1]) ?? 0);
  const nb = Number((b.match(/(\d+)/)?.[1]) ?? 0);
  return na - nb;
}

function pickCover(absProjectDir, relProjectDir, files) {
  // Prefer cover.* if you ever add it, else first numbered image, else first image
  const coverCandidates = ["cover.webp", "cover.jpg", "cover.jpeg", "cover.png"];
  for (const c of coverCandidates) {
    const p = path.join(absProjectDir, c);
    if (exists(p)) return `/${path.posix.join("projects", relProjectDir, c)}`;
  }

  const numbered = files.filter(f => /^\d+\.(jpg|jpeg|png|webp)$/i.test(f));
  const chosen = (numbered.length ? numbered : files)[0];
  return chosen ? `/${path.posix.join("projects", relProjectDir, chosen)}` : "";
}

function safePosixJoin(...parts) {
  return parts.join("/").replace(/\\/g, "/").replace(/\/+/g, "/");
}

const categories = listDirs(ROOT).filter(c => CAT_LABEL[c]);
const projects = [];

for (const category of categories) {
  const catAbs = path.join(ROOT, category);
  const projDirs = listDirs(catAbs).sort(sortProjectDirs);

  for (const projDir of projDirs) {
    const absProjectDir = path.join(catAbs, projDir);
    const relProjectDir = safePosixJoin(category, projDir);

    const files = listFiles(absProjectDir)
      .filter(isImage)
      .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" }));

    if (files.length === 0) continue;

    const slug = `${category}-${projDir}`; // e.g. renovations-project-01
    const cover = pickCover(absProjectDir, relProjectDir, files);

    const images = files.map(f => `/${safePosixJoin("projects", relProjectDir, f)}`);

    projects.push({
      slug,
      title: projDir.replace(/-/g, " ").replace(/\b\w/g, m => m.toUpperCase()), // "Project 01"
      category,
      categoryLabel: CAT_LABEL[category],
      location: "Hampshire & Surrey",
      cover,
      images,
    });
  }
}

// Sort normal order: extensions project-01.., then renovations..., then new-builds...
projects.sort((a, b) => {
  const order = (c) => (c === "extensions" ? 1 : c === "renovations" ? 2 : 3);
  const oa = order(a.category), ob = order(b.category);
  if (oa !== ob) return oa - ob;

  const na = Number(a.slug.match(/project-(\d+)/)?.[1] ?? 0);
  const nb = Number(b.slug.match(/project-(\d+)/)?.[1] ?? 0);
  return na - nb;
});

const file = `// AUTO-GENERATED. Do not edit by hand.
// Generated by scripts/generate-projects.mjs

export type Category = "extensions" | "renovations" | "new-builds";

export type Project = {
  slug: string;
  title: string;
  category: Category;
  categoryLabel: string;
  location: string;
  cover: string;
  images: string[];
};

export const projects: Project[] = ${JSON.stringify(projects, null, 2)} as const;
`;

fs.mkdirSync(path.dirname(OUT), { recursive: true });
fs.writeFileSync(OUT, file, "utf8");
console.log(`OK: Wrote ${projects.length} projects to data/projects.ts`);
